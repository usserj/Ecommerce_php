{% extends "admin/base_admin.html" %}
{% block title %}Gestión de Productos{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Admin Navigation -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <a href="{{ url_for('admin.dashboard') }}" class="btn btn-sm btn-outline-primary me-2">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                            <a href="{{ url_for('admin.users') }}" class="btn btn-sm btn-outline-primary me-2">
                                <i class="fas fa-users"></i> Usuarios
                            </a>
                            <a href="{{ url_for('admin.products') }}" class="btn btn-sm btn-primary me-2">
                                <i class="fas fa-box"></i> Productos
                            </a>
                            <a href="{{ url_for('admin.orders') }}" class="btn btn-sm btn-outline-primary me-2">
                                <i class="fas fa-shopping-cart"></i> Pedidos
                            </a>
                            <a href="{{ url_for('admin.analytics') }}" class="btn btn-sm btn-outline-primary me-2">
                                <i class="fas fa-chart-line"></i> Analíticas
                            </a>
                            <a href="{{ url_for('admin.settings') }}" class="btn btn-sm btn-outline-success me-2">
                                <i class="fas fa-cog"></i> Configuración
                            </a>
                        </div>
                        <div>
                            <span class="me-3"><i class="fas fa-user-shield"></i> {{ session.admin_nombre }}</span>
                            <a href="{{ url_for('admin.logout') }}" class="btn btn-sm btn-outline-danger">
                                <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
            <h4 class="mb-0"><i class="fas fa-box"></i> Gestión de Productos</h4>
            <div>
                <a href="{{ url_for('admin.create_product') }}" class="btn btn-light btn-sm me-2">
                    <i class="fas fa-plus"></i> Crear Producto
                </a>
                <a href="{{ url_for('admin.export_products') }}" class="btn btn-outline-light btn-sm">
                    <i class="fas fa-file-excel"></i> Exportar
                </a>
            </div>
        </div>
        <div class="card-body">
            <!-- Category Filter -->
            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <select id="categoriaFilter" class="form-control">
                        <option value="">Todas las categorías</option>
                        {% for cat in categorias %}
                        <option value="{{ cat.id }}">{{ cat.categoria }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="table-responsive">
                <table id="productsTable" class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Imagen</th>
                            <th>Título</th>
                            <th>Categoría</th>
                            <th>Precio</th>
                            <th>Stock</th>
                            <th>Ventas</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- DataTables will populate this -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirmar Eliminación</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¿Está seguro de que desea eliminar el producto <strong id="productName"></strong>?</p>
                <p class="text-danger"><i class="fas fa-exclamation-triangle"></i> Esta acción no se puede deshacer.</p>
            </div>
            <div class="modal-footer">
                <form id="deleteForm" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Eliminar</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- DataTables CSS/JS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

<script>
// Get CSRF token
function getCsrfToken() {
    return document.querySelector('input[name="csrf_token"]')?.value || '{{ csrf_token() }}';
}

// Initialize DataTable
$(document).ready(function() {
    const table = $('#productsTable').DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: '{{ url_for("admin.products_ajax") }}',
            type: 'GET',
            data: function(d) {
                d.categoria_filter = $('#categoriaFilter').val();
            }
        },
        columns: [
            { data: 'id', width: '5%' },
            {
                data: 'imagen',
                orderable: false,
                width: '10%'
            },
            { data: 'titulo', width: '20%' },
            { data: 'categoria', width: '12%' },
            { data: 'precio', width: '10%' },
            { data: 'stock', width: '10%' },
            { data: 'ventas', width: '8%' },
            {
                data: null,
                orderable: false,
                width: '10%',
                render: function(data) {
                    const checked = data.estado == 1 ? 'checked' : '';
                    return `<div class="form-check form-switch">
                        <input class="form-check-input toggle-product" type="checkbox"
                               data-id="${data.id}" ${checked}>
                    </div>`;
                }
            },
            {
                data: null,
                orderable: false,
                width: '15%',
                render: function(data) {
                    return `
                        <div class="btn-group btn-group-sm" role="group">
                            <a href="/admin/products/edit/${data.id}"
                               class="btn btn-warning" title="Editar">
                                <i class="fas fa-edit"></i>
                            </a>
                            <a href="/admin/products/${data.id}/gallery"
                               class="btn btn-info" title="Galería de Imágenes">
                                <i class="fas fa-images"></i>
                            </a>
                            <button type="button" class="btn btn-danger delete-product"
                                    data-id="${data.id}"
                                    data-titulo="${data.titulo.replace(/<[^>]*>/g, '')}"
                                    title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                }
            }
        ],
        order: [[0, 'desc']],
        language: {
            url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
        },
        pageLength: 25,
        lengthMenu: [[10, 25, 50, 100], [10, 25, 50, 100]]
    });

    // Category filter change
    $('#categoriaFilter').on('change', function() {
        table.ajax.reload();
    });

    // Toggle product status
    $('#productsTable').on('change', '.toggle-product', function() {
        const productId = $(this).data('id');
        const checkbox = this;

        fetch(`/admin/products/toggle/${productId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const message = data.estado == 1 ? 'Producto activado' : 'Producto desactivado';
                console.log(message);
            } else {
                checkbox.checked = !checkbox.checked;
                alert('Error al cambiar estado');
            }
        })
        .catch(error => {
            checkbox.checked = !checkbox.checked;
            alert('Error de conexión');
        });
    });

    // Delete product
    $('#productsTable').on('click', '.delete-product', function() {
        const productId = $(this).data('id');
        const productName = $(this).data('titulo');

        document.getElementById('productName').textContent = productName;
        document.getElementById('deleteForm').action = `/admin/products/delete/${productId}`;

        new bootstrap.Modal(document.getElementById('deleteModal')).show();
    });

    // Reload table after successful delete
    $('#deleteForm').on('submit', function() {
        setTimeout(() => table.ajax.reload(), 500);
    });
});

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
    alertDiv.style.zIndex = '9999';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    setTimeout(() => alertDiv.remove(), 3000);
}
</script>
{% endblock %}
