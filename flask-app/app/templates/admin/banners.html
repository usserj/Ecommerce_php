{% extends "admin/base_admin.html" %}
{% block title %}Gestión de Banners{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="card shadow">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h4 class="mb-0"><i class="fas fa-image"></i> Gestión de Banners</h4>
            <a href="{{ url_for('admin.create_banner') }}" class="btn btn-light btn-sm">
                <i class="fas fa-plus"></i> Crear Banner
            </a>
        </div>
        <div class="card-body">
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> Los banners son imágenes promocionales que se muestran en categorías, subcategorías o en toda la tienda.
            </div>

            <div class="table-responsive">
                <table id="bannersTable" class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Vista Previa</th>
                            <th>Tipo</th>
                            <th>Ruta/Ubicación</th>
                            <th>Estado</th>
                            <th>Fecha</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- DataTables will populate this -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirmar Eliminación</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¿Está seguro de que desea eliminar este banner?</p>
                <p class="text-danger"><i class="fas fa-exclamation-triangle"></i> Esta acción eliminará también el archivo de imagen y no se puede deshacer.</p>
            </div>
            <div class="modal-footer">
                <form id="deleteForm" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Eliminar</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- DataTables CSS/JS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

<script>
// Get CSRF token
function getCsrfToken() {
    return document.querySelector('input[name="csrf_token"]')?.value || '{{ csrf_token() }}';
}

// Initialize DataTable
$(document).ready(function() {
    const table = $('#bannersTable').DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: '{{ url_for("admin.banners_ajax") }}',
            type: 'GET'
        },
        columns: [
            { data: 'id', width: '5%' },
            {
                data: null,
                orderable: false,
                width: '15%',
                render: function(data) {
                    return `<img src="${data.img}" alt="Banner"
                            style="width: 120px; height: 40px; object-fit: cover; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">`;
                }
            },
            {
                data: 'tipo',
                width: '12%',
                render: function(data) {
                    const badges = {
                        'categorias': 'bg-info',
                        'subcategorias': 'bg-success',
                        'general': 'bg-warning text-dark'
                    };
                    return `<span class="badge ${badges[data] || 'bg-secondary'}">${data}</span>`;
                }
            },
            {
                data: 'ruta',
                width: '20%',
                render: function(data) {
                    return `<code>${data}</code>`;
                }
            },
            {
                data: null,
                width: '10%',
                render: function(data) {
                    const checked = data.activo ? 'checked' : '';
                    return `<div class="form-check form-switch">
                        <input class="form-check-input toggle-banner" type="checkbox"
                               data-id="${data.id}" ${checked}>
                    </div>`;
                }
            },
            { data: 'fecha', width: '12%' },
            {
                data: null,
                orderable: false,
                width: '15%',
                render: function(data) {
                    return `
                        <div class="btn-group btn-group-sm" role="group">
                            <a href="/admin/banners/edit/${data.id}"
                               class="btn btn-warning" title="Editar">
                                <i class="fas fa-edit"></i>
                            </a>
                            <button type="button" class="btn btn-danger delete-banner"
                                    data-id="${data.id}" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                }
            }
        ],
        order: [[0, 'desc']],
        language: {
            url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
        },
        pageLength: 10,
        lengthMenu: [[10, 25, 50, 100], [10, 25, 50, 100]]
    });

    // Toggle banner status
    $('#bannersTable').on('change', '.toggle-banner', function() {
        const bannerId = $(this).data('id');
        const checkbox = this;

        fetch(`/admin/banners/toggle/${bannerId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        })
        .then(r => r.json())
        .then(d => {
            if (!d.success) {
                checkbox.checked = !checkbox.checked;
                alert('Error al cambiar estado del banner');
            }
        })
        .catch(() => {
            checkbox.checked = !checkbox.checked;
            alert('Error de conexión');
        });
    });

    // Delete banner
    $('#bannersTable').on('click', '.delete-banner', function() {
        const bannerId = $(this).data('id');

        document.getElementById('deleteForm').action = `/admin/banners/delete/${bannerId}`;
        new bootstrap.Modal(document.getElementById('deleteModal')).show();
    });

    // Reload table after successful delete
    $('#deleteForm').on('submit', function() {
        setTimeout(() => table.ajax.reload(), 500);
    });
});
</script>
{% endblock %}
