{% extends "admin/base_admin.html" %}
{% block title %}Gestión de Subcategorías{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card admin-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Total Subcategorías</h6>
                            <h3 class="mb-0">{{ total_subcategories }}</h3>
                        </div>
                        <div class="text-info">
                            <i class="fas fa-folder-open fa-2x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card admin-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Subcategorías Activas</h6>
                            <h3 class="mb-0">{{ active_subcategories }}</h3>
                        </div>
                        <div class="text-success">
                            <i class="fas fa-check-circle fa-2x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow">
        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
            <h4 class="mb-0"><i class="fas fa-folder-open"></i> Gestión de Subcategorías</h4>
            <a href="{{ url_for('admin.create_subcategory') }}" class="btn btn-light btn-sm">
                <i class="fas fa-plus"></i> Crear Subcategoría
            </a>
        </div>
        <div class="card-body">
            <!-- Category Filter -->
            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <select id="categoriaFilter" class="form-control">
                        <option value="">Todas las categorías</option>
                        {% for cat in categorias %}
                        <option value="{{ cat.id }}">{{ cat.categoria }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="table-responsive">
                <table id="subcategoriesTable" class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Subcategoría</th>
                            <th>Categoría</th>
                            <th>Ruta</th>
                            <th>Productos</th>
                            <th>Estado</th>
                            <th>Fecha</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- DataTables will populate this -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirmar Eliminación</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¿Está seguro de que desea eliminar la subcategoría <strong id="subcategoryName"></strong>?</p>
                <p class="text-danger"><i class="fas fa-exclamation-triangle"></i> Esta acción no se puede deshacer.</p>
            </div>
            <div class="modal-footer">
                <form id="deleteForm" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Eliminar</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.opacity-50 {
    opacity: 0.5;
}
</style>
{% endblock %}

{% block extra_js %}
<!-- DataTables CSS/JS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

<script>
// Get CSRF token
function getCsrfToken() {
    return document.querySelector('input[name="csrf_token"]')?.value || '{{ csrf_token() }}';
}

// Initialize DataTable
$(document).ready(function() {
    const table = $('#subcategoriesTable').DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: '{{ url_for("admin.subcategories_ajax") }}',
            type: 'GET',
            data: function(d) {
                d.categoria_filter = $('#categoriaFilter').val();
            }
        },
        columns: [
            { data: 'id', width: '5%' },
            {
                data: 'subcategoria',
                width: '20%',
                render: function(data) {
                    return `<strong>${data}</strong>`;
                }
            },
            { data: 'categoria', width: '15%' },
            { data: 'ruta', width: '15%', orderable: true },
            {
                data: 'productos',
                width: '10%',
                orderable: false,
                render: function(data) {
                    return `<span class="badge bg-info">${data} productos</span>`;
                }
            },
            {
                data: null,
                orderable: false,
                width: '10%',
                render: function(data) {
                    const checked = data.estado == 1 ? 'checked' : '';
                    return `<div class="form-check form-switch">
                        <input class="form-check-input toggle-subcategory" type="checkbox"
                               data-id="${data.id}" ${checked}>
                    </div>`;
                }
            },
            { data: 'fecha', width: '12%' },
            {
                data: null,
                orderable: false,
                width: '13%',
                render: function(data) {
                    return `
                        <div class="btn-group btn-group-sm" role="group">
                            <a href="/admin/subcategories/edit/${data.id}"
                               class="btn btn-warning" title="Editar">
                                <i class="fas fa-edit"></i>
                            </a>
                            <button type="button" class="btn btn-danger delete-subcategory"
                                    data-id="${data.id}"
                                    data-nombre="${data.subcategoria}"
                                    title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                }
            }
        ],
        order: [[0, 'desc']],
        language: {
            url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
        },
        pageLength: 25,
        lengthMenu: [[10, 25, 50, 100], [10, 25, 50, 100]]
    });

    // Category filter change
    $('#categoriaFilter').on('change', function() {
        table.ajax.reload();
    });

    // Toggle subcategory status
    $('#subcategoriesTable').on('change', '.toggle-subcategory', function() {
        const subcategoryId = $(this).data('id');
        const checkbox = this;

        fetch(`/admin/subcategories/toggle/${subcategoryId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        })
        .then(r => r.json())
        .then(d => {
            if (!d.success) {
                checkbox.checked = !checkbox.checked;
                alert('Error al cambiar estado');
            }
        })
        .catch(() => {
            checkbox.checked = !checkbox.checked;
            alert('Error de conexión');
        });
    });

    // Delete subcategory
    $('#subcategoriesTable').on('click', '.delete-subcategory', function() {
        const subcategoryId = $(this).data('id');
        const subcategoryName = $(this).data('nombre');

        document.getElementById('subcategoryName').textContent = subcategoryName;
        document.getElementById('deleteForm').action = `/admin/subcategories/delete/${subcategoryId}`;

        new bootstrap.Modal(document.getElementById('deleteModal')).show();
    });

    // Reload table after successful delete
    $('#deleteForm').on('submit', function() {
        setTimeout(() => table.ajax.reload(), 500);
    });
});
</script>
{% endblock %}
