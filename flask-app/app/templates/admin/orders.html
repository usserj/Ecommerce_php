{% extends "admin/base_admin.html" %}
{% block title %}Gestión de Pedidos{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <a href="{{ url_for('admin.dashboard') }}" class="btn btn-sm btn-outline-primary me-2">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                            <a href="{{ url_for('admin.users') }}" class="btn btn-sm btn-outline-primary me-2">
                                <i class="fas fa-users"></i> Usuarios
                            </a>
                            <a href="{{ url_for('admin.products') }}" class="btn btn-sm btn-outline-primary me-2">
                                <i class="fas fa-box"></i> Productos
                            </a>
                            <a href="{{ url_for('admin.orders') }}" class="btn btn-sm btn-primary me-2">
                                <i class="fas fa-shopping-cart"></i> Pedidos
                            </a>
                            <a href="{{ url_for('admin.analytics') }}" class="btn btn-sm btn-outline-primary me-2">
                                <i class="fas fa-chart-line"></i> Analíticas
                            </a>
                            <a href="{{ url_for('admin.settings') }}" class="btn btn-sm btn-outline-success me-2">
                                <i class="fas fa-cog"></i> Configuración
                            </a>
                        </div>
                        <div>
                            <span class="me-3"><i class="fas fa-user-shield"></i> {{ session.admin_nombre }}</span>
                            <a href="{{ url_for('admin.logout') }}" class="btn btn-sm btn-outline-danger">
                                <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card admin-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Total Órdenes</h6>
                            <h3 class="mb-0">{{ total_orders }}</h3>
                        </div>
                        <div class="text-primary">
                            <i class="fas fa-shopping-cart fa-2x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card admin-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Ingresos Totales</h6>
                            <h3 class="mb-0">${{ "%.2f"|format(total_revenue) }}</h3>
                        </div>
                        <div class="text-success">
                            <i class="fas fa-dollar-sign fa-2x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card admin-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Pendientes</h6>
                            <h3 class="mb-0">{{ pending_orders }}</h3>
                        </div>
                        <div class="text-warning">
                            <i class="fas fa-clock fa-2x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card admin-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Completadas</h6>
                            <h3 class="mb-0">{{ completed_orders }}</h3>
                        </div>
                        <div class="text-info">
                            <i class="fas fa-check-circle fa-2x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow">
        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
            <h4 class="mb-0"><i class="fas fa-shopping-cart"></i> Gestión de Pedidos</h4>
            <a href="{{ url_for('admin.export_orders') }}" class="btn btn-light btn-sm">
                <i class="fas fa-file-excel"></i> Exportar a Excel
            </a>
        </div>
        <div class="card-body">
            <!-- Filters -->
            <div class="mb-4">
                <h6 class="text-muted mb-3"><i class="fas fa-filter"></i> Filtros Avanzados</h6>
                <div class="row g-3 mb-3">
                    <div class="col-md-3">
                        <label for="metodoFilter" class="form-label small text-muted">Método de Pago</label>
                        <select id="metodoFilter" class="form-control">
                            <option value="">Todos los métodos</option>
                            <option value="paypal">PayPal</option>
                            <option value="paymentez">Paymentez</option>
                            <option value="datafast">Datafast</option>
                            <option value="deuna">De Una</option>
                            <option value="transferencia">Transferencia</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="estadoFilter" class="form-label small text-muted">Estado</label>
                        <select id="estadoFilter" class="form-control">
                            <option value="">Todos los estados</option>
                            <option value="pendiente">Pendiente</option>
                            <option value="procesando">Procesando</option>
                            <option value="enviado">Enviado</option>
                            <option value="entregado">Entregado</option>
                            <option value="completado">Completado</option>
                            <option value="cancelado">Cancelado</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="fechaDesde" class="form-label small text-muted">Fecha Desde</label>
                        <input type="date" id="fechaDesde" class="form-control" placeholder="Desde">
                    </div>
                    <div class="col-md-3">
                        <label for="fechaHasta" class="form-label small text-muted">Fecha Hasta</label>
                        <input type="date" id="fechaHasta" class="form-control" placeholder="Hasta">
                    </div>
                </div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="usuarioFilter" class="form-label small text-muted">Buscar por Cliente</label>
                        <input type="text" id="usuarioFilter" class="form-control" placeholder="Nombre o email del cliente">
                    </div>
                    <div class="col-md-6 d-flex align-items-end">
                        <button type="button" id="clearFilters" class="btn btn-outline-secondary me-2">
                            <i class="fas fa-times"></i> Limpiar Filtros
                        </button>
                        <button type="button" id="applyFilters" class="btn btn-primary">
                            <i class="fas fa-filter"></i> Aplicar Filtros
                        </button>
                    </div>
                </div>
            </div>

            <div class="table-responsive">
                <table id="ordersTable" class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Cliente</th>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th>Total</th>
                            <th>Método Pago</th>
                            <th>Estado</th>
                            <th>Fecha</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- DataTables will populate this -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Update Status Modal -->
<div class="modal fade" id="statusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">Actualizar Estado de Orden</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="statusForm" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Estado *</label>
                        <select name="estado" class="form-control" required>
                            <option value="pendiente">Pendiente</option>
                            <option value="procesando">Procesando</option>
                            <option value="enviado">Enviado</option>
                            <option value="entregado">Entregado</option>
                            <option value="completado">Completado</option>
                            <option value="cancelado">Cancelado</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Número de Tracking (opcional)</label>
                        <input type="text" name="tracking" class="form-control" placeholder="Ej: TRACK123456">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-warning">Actualizar Estado</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.opacity-50 {
    opacity: 0.5;
}
</style>
{% endblock %}

{% block extra_js %}
<!-- DataTables CSS/JS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

<script>
// Get CSRF token
function getCsrfToken() {
    return '{{ csrf_token() }}';
}

// Initialize DataTable
$(document).ready(function() {
    const table = $('#ordersTable').DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: '{{ url_for("admin.orders_ajax") }}',
            type: 'GET',
            data: function(d) {
                d.metodo_filter = $('#metodoFilter').val();
                d.estado_filter = $('#estadoFilter').val();
                d.fecha_desde = $('#fechaDesde').val();
                d.fecha_hasta = $('#fechaHasta').val();
                d.usuario_filter = $('#usuarioFilter').val();
            }
        },
        columns: [
            { data: 'id', width: '5%' },
            { data: 'cliente', orderable: true, width: '15%' },
            { data: 'producto', orderable: true, width: '15%' },
            { data: 'cantidad', orderable: true, width: '8%' },
            { data: 'total', orderable: true, width: '10%' },
            { data: 'metodo', orderable: false, width: '12%' },
            {
                data: 'estado_html',
                orderable: true,
                width: '10%'
            },
            { data: 'fecha', orderable: true, width: '15%' },
            {
                data: null,
                orderable: false,
                width: '10%',
                render: function(data) {
                    return `
                        <button class="btn btn-sm btn-warning update-status"
                                data-id="${data.id}"
                                data-estado="${data.estado}"
                                data-tracking="${data.tracking}">
                            <i class="fas fa-edit"></i>
                        </button>
                    `;
                }
            }
        ],
        order: [[0, 'desc']],
        language: {
            url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
        },
        pageLength: 25,
        lengthMenu: [[10, 25, 50, 100], [10, 25, 50, 100]]
    });

    // Auto-apply filters for dropdowns
    $('#metodoFilter, #estadoFilter').on('change', function() {
        table.ajax.reload();
    });

    // Apply filters button
    $('#applyFilters').on('click', function() {
        table.ajax.reload();
    });

    // Clear filters button
    $('#clearFilters').on('click', function() {
        $('#metodoFilter').val('');
        $('#estadoFilter').val('');
        $('#fechaDesde').val('');
        $('#fechaHasta').val('');
        $('#usuarioFilter').val('');
        table.ajax.reload();
    });

    // Allow Enter key on user filter
    $('#usuarioFilter').on('keypress', function(e) {
        if (e.which === 13) {
            table.ajax.reload();
        }
    });

    // Date change auto-apply
    $('#fechaDesde, #fechaHasta').on('change', function() {
        table.ajax.reload();
    });

    // Update status
    $('#ordersTable').on('click', '.update-status', function() {
        const orderId = $(this).data('id');
        const currentEstado = $(this).data('estado');
        const currentTracking = $(this).data('tracking');

        const form = document.getElementById('statusForm');
        form.action = `/admin/orders/update-status/${orderId}`;
        form.querySelector('[name="estado"]').value = currentEstado;
        form.querySelector('[name="tracking"]').value = currentTracking || '';

        new bootstrap.Modal(document.getElementById('statusModal')).show();
    });

    // Reload table after status update
    $('#statusForm').on('submit', function(e) {
        e.preventDefault();

        fetch(this.action, {
            method: 'POST',
            body: new FormData(this)
        })
        .then(response => {
            if (response.ok) {
                bootstrap.Modal.getInstance(document.getElementById('statusModal')).hide();
                table.ajax.reload();
                alert('Estado actualizado correctamente');
            }
        })
        .catch(error => {
            alert('Error al actualizar estado');
        });
    });
});
</script>
{% endblock %}
